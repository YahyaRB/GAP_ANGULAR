<div class="page-wrapper">
  <div class="page-content-wrapper">
    <div class="page-content">

      <!-- Header Section -->
      <div class="dashboard-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 class="page-title mb-1">
              <i class='bx bxs-dashboard gradient-icon'></i>
              Tableau de Bord
            </h2>
            <p class="text-muted mb-0">
              <i class='bx bx-user-circle'></i>
              Connecté en tant que <strong>{{ getRoleDisplayName() }}</strong>
              <span *ngIf="isAgentSaisie" class="badge badge-info ml-2">
                <i class='bx bx-building'></i> Vue Atelier
              </span>
              <span *ngIf="isAdmin || isConsulteur" class="badge badge-success ml-2">
                <i class='bx bx-globe'></i> Vue Globale
              </span>
            </p>
          </div>
          <div>
            <button class="btn btn-primary btn-refresh" (click)="loadDashboardData()">
              <i class='bx bx-refresh' [class.spinning]="loading"></i>
              Actualiser
            </button>
          </div>
        </div>
      </div>

      <!-- Loading Spinner -->
      <div *ngIf="loading" class="loading-container">
        <div class="spinner-border text-primary" role="status">
          <span class="sr-only">Chargement...</span>
        </div>
        <p class="mt-3 text-muted">Chargement des statistiques...</p>
      </div>

      <!-- Dashboard Content -->
      <div *ngIf="!loading">

        <!-- Stats Cards Row 1 -->
        <div class="row">
          <div class="col-12 col-lg-3 col-md-6">
            <div class="card stats-card card-hover gradient-card-1">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stats-icon bg-white">
                    <i class='bx bx-briefcase'></i>
                  </div>
                  <div class="ml-auto text-right">
                    <h3 class="mb-0 text-white stats-number">{{ stats.totalProjets }}</h3>
                    <p class="mb-0 text-white-50">Total Projets</p>
                  </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                  <div class="progress-bar bg-white" role="progressbar" [style.width]="'100%'" aria-valuenow="100"
                    aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-3 col-md-6">
            <div class="card stats-card card-hover gradient-card-2">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stats-icon bg-white">
                    <i class='bx bx-check-circle'></i>
                  </div>
                  <div class="ml-auto text-right">
                    <h3 class="mb-0 text-white stats-number">{{ stats.projetsActifs }}</h3>
                    <p class="mb-0 text-white-50">Projets Actifs</p>
                  </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                  <div class="progress-bar bg-white" role="progressbar"
                    [style.width]="getProgressPercentage(stats.projetsActifs, stats.totalProjets) + '%'"
                    [attr.aria-valuenow]="getProgressPercentage(stats.projetsActifs, stats.totalProjets)"
                    aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-3 col-md-6">
            <div class="card stats-card card-hover gradient-card-3">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stats-icon bg-white">
                    <i class='bx bx-user-check'></i>
                  </div>
                  <div class="ml-auto text-right">
                    <h3 class="mb-0 text-white stats-number">{{ stats.totalAffectations }}</h3>
                    <p class="mb-0 text-white-50">Affectations</p>
                  </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                  <div class="progress-bar bg-white" role="progressbar" [style.width]="'100%'" aria-valuenow="100"
                    aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-3 col-md-6">
            <div class="card stats-card card-hover gradient-card-4">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stats-icon bg-white">
                    <i class='bx bx-package'></i>
                  </div>
                  <div class="ml-auto text-right">
                    <h3 class="mb-0 text-white stats-number">{{ stats.totalLivraisons }}</h3>
                    <p class="mb-0 text-white-50">Livraisons</p>
                  </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                  <div class="progress-bar bg-white" role="progressbar" [style.width]="'100%'" aria-valuenow="100"
                    aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stats Cards Row 2 -->
        <div class="row">
          <div class="col-12 col-lg-3 col-md-6">
            <div class="card stats-card card-hover gradient-card-5">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stats-icon bg-white">
                    <i class='bx bx-car'></i>
                  </div>
                  <div class="ml-auto text-right">
                    <h3 class="mb-0 text-white stats-number">{{ stats.totalDeplacements }}</h3>
                    <p class="mb-0 text-white-50">Déplacements</p>
                  </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                  <div class="progress-bar bg-white" role="progressbar" [style.width]="'100%'" aria-valuenow="100"
                    aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-3 col-md-6">
            <div class="card stats-card card-hover gradient-card-6">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stats-icon bg-white">
                    <i class='bx bx-box'></i>
                  </div>
                  <div class="ml-auto text-right">
                    <h3 class="mb-0 text-white stats-number">{{ stats.totalArticles }}</h3>
                    <p class="mb-0 text-white-50">Articles</p>
                  </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                  <div class="progress-bar bg-white" role="progressbar" [style.width]="'100%'" aria-valuenow="100"
                    aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-3 col-md-6">
            <div class="card stats-card card-hover gradient-card-7">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stats-icon bg-white">
                    <i class='bx bx-group'></i>
                  </div>
                  <div class="ml-auto text-right">
                    <h3 class="mb-0 text-white stats-number">{{ stats.totalEmployes }}</h3>
                    <p class="mb-0 text-white-50">Employés</p>
                  </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                  <div class="progress-bar bg-white" role="progressbar" [style.width]="'100%'" aria-valuenow="100"
                    aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-3 col-md-6">
            <div class="card stats-card card-hover gradient-card-8">
              <div class="card-body">
                <div class="d-flex align-items-center">
                  <div class="stats-icon bg-white">
                    <i class='bx bx-cog'></i>
                  </div>
                  <div class="ml-auto text-right">
                    <h3 class="mb-0 text-white stats-number">{{ stats.totalOFs }}</h3>
                    <p class="mb-0 text-white-50">Ordres de Fabrication</p>
                  </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                  <div class="progress-bar bg-white" role="progressbar" [style.width]="'100%'" aria-valuenow="100"
                    aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
          <div class="col-12 col-lg-4">
            <div class="card chart-card">
              <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                  <i class='bx bx-pie-chart-alt-2 text-primary'></i>
                  État des Projets
                </h5>
              </div>
              <div class="card-body">
                <div class="chart-container">
                  <div class="donut-chart">
                    <div class="chart-center">
                      <h3 class="mb-0">{{ stats.totalProjets }}</h3>
                      <p class="text-muted mb-0">Total</p>
                    </div>
                    <svg viewBox="0 0 200 200" class="donut-svg">
                      <circle cx="100" cy="100" r="80" fill="none" stroke="#e9ecef" stroke-width="30"></circle>
                      <circle cx="100" cy="100" r="80" fill="none" stroke="#4CAF50" stroke-width="30"
                        [attr.stroke-dasharray]="(stats.projetsActifs / stats.totalProjets * 502.4) + ' 502.4'"
                        transform="rotate(-90 100 100)"></circle>
                    </svg>
                  </div>
                  <div class="chart-legend mt-3">
                    <div class="d-flex justify-content-between mb-2">
                      <span><i class='bx bxs-circle text-success'></i> Actifs</span>
                      <strong>{{ stats.projetsActifs }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span><i class='bx bxs-circle text-danger'></i> Terminés</span>
                      <strong>{{ stats.projetsTermines }}</strong>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-8">
            <div class="card chart-card">
              <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                  <i class='bx bx-bar-chart-alt-2 text-primary'></i>
                  Vue d'ensemble des Activités
                </h5>
              </div>
              <div class="card-body">
                <div class="bar-chart-container">
                  <div class="bar-chart-item" *ngFor="let item of [
                    {label: 'Affectations', value: stats.totalAffectations, color: '#2196F3', icon: 'bx-user-check'},
                    {label: 'Livraisons', value: stats.totalLivraisons, color: '#4CAF50', icon: 'bx-package'},
                    {label: 'Déplacements', value: stats.totalDeplacements, color: '#FF9800', icon: 'bx-car'},
                    {label: 'OFs', value: stats.totalOFs, color: '#9C27B0', icon: 'bx-cog'}
                  ]">
                    <div class="d-flex align-items-center mb-2">
                      <i class='bx {{ item.icon }}' [style.color]="item.color"></i>
                      <span class="ml-2">{{ item.label }}</span>
                      <strong class="ml-auto">{{ item.value }}</strong>
                    </div>
                    <div class="progress" style="height: 8px;">
                      <div class="progress-bar" role="progressbar"
                        [style.width]="(item.value / getMaxActivity() * 100) + '%'"
                        [style.background-color]="item.color"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activities -->
        <div class="row">
          <div class="col-12">
            <div class="card activities-card">
              <div class="card-header bg-transparent border-0">
                <h5 class="card-title mb-0">
                  <i class='bx bx-time-five text-primary'></i>
                  Activités Récentes
                </h5>
              </div>
              <div class="card-body">
                <div *ngIf="stats.recentActivities.length === 0" class="text-center py-5">
                  <i class='bx bx-info-circle text-muted' style="font-size: 48px;"></i>
                  <p class="text-muted mt-3">Aucune activité récente</p>
                </div>
                <div class="timeline" *ngIf="stats.recentActivities.length > 0">
                  <div class="timeline-item" *ngFor="let activity of stats.recentActivities; let i = index">
                    <div class="timeline-marker" [ngClass]="'bg-' + activity.color">
                      <i class='bx {{ activity.icon }}'></i>
                    </div>
                    <div class="timeline-content">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <span class="badge" [ngClass]="'badge-' + activity.color">{{ activity.type }}</span>
                          <p class="mb-1 mt-2">{{ activity.description }}</p>
                        </div>
                        <small class="text-muted">{{ formatDate(activity.date) }}</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>