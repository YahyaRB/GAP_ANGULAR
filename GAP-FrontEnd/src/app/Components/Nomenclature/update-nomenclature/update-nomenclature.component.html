<div class="modal-dialog modal-dialog-centered modal-lg-custom">
  <div class="modal-content card radius-15">
    <div class="modal-header">
      <h5 class="modal-title">Modifier une nomenclature</h5>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <form name="form" [formGroup]="myFormUpdate" (ngSubmit)="onUpdate()">
      <div class="modal-body">

        <!-- Informations de l'OF -->
        <div class="row mb-3" *ngIf="ordreFabrication">
          <div class="col-12">
            <div class="alert alert-info">
              <strong>Ordre de Fabrication :</strong> {{ordreFabrication.numOF}} -
              <strong>Quantité OF :</strong> {{ordreFabrication.quantite | number:'1.0-2'}}
            </div>
          </div>
        </div>

        <!-- Informations nomenclature actuelle -->
        <div class="row mb-3" *ngIf="nomenclature">
          <div class="col-12">
            <div class="alert alert-warning">
              <div class="row">
                <div class="col-md-6">
                  <strong>Quantité actuelle :</strong>
                  {{getQuantiteAbsolueActuelle() | number:'1.0-2'}}
                  <br>
                  <small class="text-muted">
                    Soit {{getQuantiteRelativeActuelle() | number:'1.0-4'}} par unité d'OF
                  </small>
                </div>
                <div class="col-md-6">
                  <strong>Quantité livrée :</strong> {{nomenclature.quantiteLivre | number:'1.0-2'}}
                  <br>
                  <strong>Quantité restante :</strong> {{nomenclature.quantiteRest | number:'1.0-2'}}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sélecteur de mode de saisie -->
        <div class="row mb-3">
          <div class="col-12">
            <div class="card bg-light">
              <div class="card-body p-3">
                <h6 class="card-title mb-2">Mode de saisie</h6>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="modeQuantite"
                         id="modeRelatif" [value]="false" [(ngModel)]="useModeAbsolu"
                         [ngModelOptions]="{standalone: true}" (change)="toggleMode()">
                  <label class="form-check-label" for="modeRelatif">
                    <strong>Relatif</strong> - Quantité par unité d'OF
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="modeQuantite"
                         id="modeAbsolu" [value]="true" [(ngModel)]="useModeAbsolu"
                         [ngModelOptions]="{standalone: true}" (change)="toggleMode()">
                  <label class="form-check-label" for="modeAbsolu">
                    <strong>Absolu</strong> - Quantité totale directe
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Type de nomenclature -->
        <div class="row mb-3">
          <label class="col-sm-3 col-form-label">Type</label>
          <div class="col-sm-9">
            <ng-select placeholder="Sélectionnez un type"
                       formControlName="type" name="type">
              <ng-option *ngFor="let type of typesNomenclature" [value]="type.value">
                {{type.label}}
              </ng-option>
            </ng-select>
          </div>
        </div>

        <!-- Désignation -->
        <div class="row mb-3">
          <label class="col-sm-3 col-form-label">Désignation</label>
          <div class="col-sm-9">
            <input type="text" id="designation" class="form-control"
                   placeholder="Désignation de la nomenclature"
                   formControlName="designation">
          </div>
        </div>

        <!-- Unité -->
        <div class="row mb-3">
          <label class="col-sm-3 col-form-label">Unité</label>
          <div class="col-sm-9">
            <ng-select placeholder="Sélectionnez une unité"
                       formControlName="unite" name="unite">
              <ng-option *ngFor="let unite of unites" [value]="unite.value">
                {{unite.label}} ({{unite.value}})
              </ng-option>
            </ng-select>
          </div>
        </div>

        <!-- Quantité selon le mode choisi -->
        <div class="row mb-3">
          <label class="col-sm-3 col-form-label">
            <span *ngIf="!useModeAbsolu">Quantité par unité</span>
            <span *ngIf="useModeAbsolu">Quantité totale</span>
          </label>
          <div class="col-sm-9">
            <input type="number" id="quantite" class="form-control"
                   [class.is-invalid]="!isQuantiteCoherente()"
                   step="0.01" min="0.01"
                   [placeholder]="useModeAbsolu ? 'Quantité totale nécessaire' : 'Quantité nécessaire par unité d\'OF'"
                   formControlName="quantite">
            <small class="form-text text-muted" *ngIf="!useModeAbsolu">
              Quantité nécessaire pour produire 1 unité de l'ordre de fabrication
            </small>
            <small class="form-text text-muted" *ngIf="useModeAbsolu">
              Quantité totale nécessaire pour tout l'ordre de fabrication
            </small>

            <!-- Message d'erreur pour quantité incohérente -->
            <div class="invalid-feedback" *ngIf="!isQuantiteCoherente()">
              {{getMessageErreurQuantite()}}
            </div>
          </div>
        </div>

        <!-- Aperçu des calculs -->
        <div class="row mb-3" *ngIf="myFormUpdate.get('quantite')?.value && ordreFabrication">
          <div class="col-12">
            <div class="card" [class.border-success]="isQuantiteCoherente()" [class.border-danger]="!isQuantiteCoherente()">
              <div class="card-header py-2" [class.bg-success]="isQuantiteCoherente()" [class.bg-danger]="!isQuantiteCoherente()">
                <h6 class="mb-0 text-white">Aperçu des quantités</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-4">
                    <strong>Quantité totale :</strong>
                    <div class="h5 text-primary">
                      {{getQuantiteTotaleCalculee() | number:'1.0-2'}}
                    </div>
                    <small class="text-muted" *ngIf="!useModeAbsolu">
                      ({{ordreFabrication.quantite}} × {{myFormUpdate.get('quantite')?.value}})
                    </small>
                  </div>
                  <div class="col-md-4">
                    <strong>Quantité par unité :</strong>
                    <div class="h5 text-info">
                      {{useModeAbsolu ? (getQuantiteTotaleCalculee() / ordreFabrication.quantite | number:'1.0-4') : (myFormUpdate.get('quantite')?.value | number:'1.0-4')}}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <strong>Nouvelle qté restante :</strong>
                    <div class="h5" [class.text-success]="isQuantiteCoherente()" [class.text-danger]="!isQuantiteCoherente()">
                      {{(getQuantiteTotaleCalculee() - (nomenclature?.quantiteLivre || 0)) | number:'1.0-2'}}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Comparaison avec les valeurs actuelles -->
        <div class="row mb-3" *ngIf="nomenclature && myFormUpdate.get('quantite')?.value">
          <div class="col-12">
            <div class="alert alert-secondary">
              <h6>Comparaison avec les valeurs actuelles :</h6>
              <div class="row">
                <div class="col-md-6">
                  <strong>Quantité actuelle :</strong> {{getQuantiteAbsolueActuelle() | number:'1.0-2'}}
                  <br>
                  <strong>Nouvelle quantité :</strong> {{getQuantiteTotaleCalculee() | number:'1.0-2'}}
                </div>
                <div class="col-md-6">
                  <strong>Différence :</strong>
                  <span [class.text-success]="(getQuantiteTotaleCalculee() - getQuantiteAbsolueActuelle()) > 0"
                        [class.text-danger]="(getQuantiteTotaleCalculee() - getQuantiteAbsolueActuelle()) < 0"
                        [class.text-muted]="(getQuantiteTotaleCalculee() - getQuantiteAbsolueActuelle()) === 0">
                    {{(getQuantiteTotaleCalculee() - getQuantiteAbsolueActuelle()) | number:'1.0-2'}}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Avertissement si quantité livrée -->
        <div class="row mb-3" *ngIf="nomenclature && nomenclature.quantiteLivre > 0">
          <div class="col-12">
            <div class="alert alert-warning">
              <strong>⚠️ Attention :</strong>
              Cette nomenclature a déjà une quantité livrée de {{nomenclature.quantiteLivre | number:'1.0-2'}}.
              La nouvelle quantité totale doit être supérieure ou égale à cette valeur.
            </div>
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" #closebutton data-dismiss="modal">Fermer</button>
        <button type="submit"
                [disabled]="!myFormUpdate.valid || !isQuantiteCoherente()"
                class="btn btn-primary">
          Valider
        </button>
      </div>
    </form>
  </div>
</div>
