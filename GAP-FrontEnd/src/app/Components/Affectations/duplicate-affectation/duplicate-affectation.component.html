<!-- duplicate-affectation.component.html -->
<div class="modal-dialog modal-xl">
  <div class="modal-content">
    <!-- En-tête avec navigation -->
    <div class="modal-header">
      <h5 class="modal-title">
        <span *ngIf="currentStep === 1">Dupliquer les affectations - Configuration</span>
        <span *ngIf="currentStep === 2">Dupliquer les affectations - Prévisualisation</span>
      </h5>
      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body">
      <!-- Message d'information ou d'erreur -->
      <div *ngIf="message" class="alert mb-3" [ngClass]="{
        'alert-success': messageType === 'success',
        'alert-danger': messageType === 'error'
      }">
        <pre>{{ message }}</pre>
      </div>

      <!-- ÉTAPE 1: Configuration -->
      <div *ngIf="currentStep === 1">
        <form [formGroup]="duplicateForm">
          <div class="row">
            <!-- Sélection de l'atelier -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="atelierId" class="form-label">Atelier <span class="text-danger">*</span></label>
                <select id="atelierId" class="form-control" formControlName="atelierId">
                  <option value="">Sélectionnez un atelier</option>
                  <option *ngFor="let atelier of ateliers" [value]="atelier.id">
                    {{ atelier.designation }}
                  </option>
                </select>
                <div *ngIf="duplicateForm.get('atelierId')?.invalid && duplicateForm.get('atelierId')?.touched"
                     class="text-danger small">
                  L'atelier est obligatoire
                </div>
              </div>
            </div>

            <!-- Date source -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="sourceDate" class="form-label">Date source <span class="text-danger">*</span></label>
                <input type="date"
                       id="sourceDate"
                       class="form-control"
                       formControlName="sourceDate"
                       [max]="duplicateForm.get('targetDate')?.value">
                <div *ngIf="duplicateForm.get('sourceDate')?.invalid && duplicateForm.get('sourceDate')?.touched"
                     class="text-danger small">
                  La date source est obligatoire
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Date cible -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="targetDate" class="form-label">Date cible <span class="text-danger">*</span></label>
                <input type="date"
                       id="targetDate"
                       class="form-control"
                       formControlName="targetDate"
                       [min]="duplicateForm.get('sourceDate')?.value">
                <div *ngIf="duplicateForm.get('targetDate')?.invalid && duplicateForm.get('targetDate')?.touched"
                     class="text-danger small">
                  La date cible est obligatoire
                </div>
              </div>
            </div>

            <!-- Sélection des périodes -->
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Périodes à dupliquer <span class="text-danger">*</span></label>

                <!-- Option "Tout sélectionner" -->
                <div class="form-check mb-2">
                  <input type="checkbox"
                         class="form-check-input"
                         id="selectAllPeriodes"
                         [checked]="selectAllPeriodes"
                         (change)="onSelectAllPeriodesChange($event)">
                  <label class="form-check-label font-weight-bold" for="selectAllPeriodes">
                    Toutes les périodes
                  </label>
                </div>

                <hr class="my-2">

                <!-- Options individuelles -->
                <div *ngFor="let periode of periodes" class="form-check">
                  <input type="checkbox"
                         class="form-check-input"
                         [id]="'periode_' + periode.value"
                         [checked]="selectedPeriodes.includes(periode.value)"
                         [disabled]="selectAllPeriodes"
                         (change)="onPeriodeChange(periode.value, $event)">
                  <label class="form-check-label" [for]="'periode_' + periode.value">
                    {{ periode.label }}
                  </label>
                </div>

                <div *ngIf="selectedPeriodes.length === 0 && !selectAllPeriodes" class="text-danger small mt-1">
                  Veuillez sélectionner au moins une période
                </div>
              </div>
            </div>
          </div>

          <!-- Information -->
          <div class="alert alert-info">
            <i class="bx bx-info-circle"></i>
            <strong>Information :</strong> Cette opération va afficher une prévisualisation des affectations
            à dupliquer. Vous pourrez ensuite modifier les heures et sélectionner celles à enregistrer.
          </div>
        </form>
      </div>

      <!-- ÉTAPE 2: Prévisualisation -->
      <div *ngIf="currentStep === 2">
        <!-- Statistiques -->
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="card bg-primary text-white">
              <div class="card-body text-center">
                <h5>{{ getTotalCount() }}</h5>
                <small>Total trouvé</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body text-center">
                <h5>{{ getSelectedCount() }}</h5>
                <small>Sélectionnés</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-warning text-white">
              <div class="card-body text-center">
                <h5>{{ getConflictCount() }}</h5>
                <small>Conflits</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-info text-white">
              <div class="card-body text-center">
                <h5>{{ getTotalCount() - getConflictCount() }}</h5>
                <small>Disponibles</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Table de prévisualisation -->
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-sm table-striped">
            <thead class="thead-light sticky-top">
            <tr>
              <th width="40">
                <input type="checkbox"
                       [checked]="selectAll"
                       [indeterminate]="getSelectedCount() > 0 && !selectAll"
                       (change)="onSelectAllChange($event)"
                       class="form-check-input">
              </th>
              <th>Employé</th>
              <th>Projet</th>
              <th>Article</th>
              <th>Période</th>
              <th width="80">Heures</th>
              <th>Statut</th>
              <th width="40">Action</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let item of previewData; trackBy: trackByTempId"
                [ngClass]="{'table-danger': item.hasConflict, 'table-success': selectedItems.has(item.tempId)}">
              <td>
                <input type="checkbox"
                       [checked]="selectedItems.has(item.tempId)"
                       [disabled]="item.hasConflict"
                       (change)="onItemSelect(item.tempId, $event)"
                       class="form-check-input">
              </td>
              <td>
                <div class="text-truncate" style="max-width: 150px;" [title]="item.employeeName">
                  <strong>{{ item.employeeName }}</strong><br>
                  <small class="text-muted">{{ item.employeeMatricule }}</small>
                </div>
              </td>
              <td>
                <div class="text-truncate" style="max-width: 180px;" [title]="item.projetCode + ' - ' + item.projetDesignation">
                  <strong>{{ item.projetCode }}</strong><br>
                  <small>{{ item.projetDesignation }}</small>
                </div>
              </td>
              <td>
                <div class="text-truncate" style="max-width: 150px;" [title]="item.articleNumPrix + ' - ' + item.articleDesignation">
                  <strong>{{ item.articleNumPrix }}</strong><br>
                  <small>{{ item.articleDesignation }}</small>
                </div>
              </td>
              <td>
                  <span class="badge" [ngClass]="{
                    'badge-primary': item.periode === 'Matin',
                    'badge-info': item.periode === 'Après-midi',
                    'badge-secondary': item.periode === 'Heures',
                    'badge-warning': item.periode === 'Heures_Sup'
                  }">
                    {{ item.periode }}
                  </span>
              </td>
              <td>
                <input type="number"
                       class="form-control form-control-sm"
                       [value]="item.nombreHeures"
                       [readonly]="!item.canModifyHours"
                       [min]="1"
                       [max]="item.periode === 'Heures_Sup' ? 24 : 9"

                       style="width: 70px;">
              </td>
              <td>
                <div *ngIf="item.hasConflict">
                  <i class="bx bx-error text-danger" [title]="item.conflictMessage"></i>
                  <small class="text-danger d-block">{{ item.conflictMessage }}</small>
                </div>
                <div *ngIf="!item.hasConflict">
                  <i class="bx bx-check text-success" title="Prêt à enregistrer"></i>
                </div>
              </td>
              <td>
                <button type="button"
                        class="btn btn-sm btn-outline-danger"
                        (click)="removeItem(item.tempId)"
                        title="Supprimer cette ligne">
                  <i class="bx bx-trash"></i>
                </button>
              </td>
            </tr>
            </tbody>
          </table>
        </div>

        <!-- Message si aucune donnée -->
        <div *ngIf="previewData.length === 0" class="alert alert-warning text-center">
          <i class="bx bx-info-circle"></i>
          Aucune affectation trouvée pour les critères spécifiés.
        </div>

        <!-- Légende -->
        <div class="mt-3">
          <small>
            <strong>Légende :</strong>
            <span class="badge badge-primary ml-2">Matin</span>
            <span class="badge badge-info ml-1">Après-midi</span>
            <span class="badge badge-secondary ml-1">Heures</span>
            <span class="badge badge-warning ml-1">Heures_Sup</span>
            <br>
            <i class="bx bx-info-circle text-info"></i> Les heures peuvent être modifiées pour les périodes "Heures" et "Heures_Sup"
          </small>
        </div>
      </div>
    </div>

    <!-- Pied de page avec boutons -->
    <div class="modal-footer">
      <div class="d-flex w-100 justify-content-between align-items-center">
        <!-- Boutons de navigation -->
        <div>
          <button *ngIf="currentStep === 2"
                  type="button"
                  class="btn btn-outline-secondary"
                  (click)="goBack()"
                  [disabled]="isLoading">
            <i class="bx bx-arrow-back"></i> Retour
          </button>
        </div>

        <!-- Informations et actions -->
        <div class="d-flex align-items-center">
          <div *ngIf="currentStep === 2 && getSelectedCount() > 0" class="mr-3">
            <small class="text-muted">
              {{ getSelectedCount() }} élément(s) sélectionné(s)
            </small>
          </div>

          <!-- Boutons d'action -->
          <button type="button"
                  class="btn btn-secondary mr-2"
                  data-dismiss="modal"
                  (click)="onCancel()"
                  [disabled]="isLoading">
            Annuler
          </button>

          <button *ngIf="currentStep === 1"
                  type="button"
                  class="btn btn-primary"
                  (click)="onPreview()"
                  [disabled]="isLoading || duplicateForm.invalid || (selectedPeriodes.length === 0 && !selectAllPeriodes)">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm mr-2"></span>
            {{ isLoading ? 'Chargement...' : 'Prévisualiser' }}
            <i class="bx bx-search-alt ml-1"></i>
          </button>

          <button *ngIf="currentStep === 2"
                  type="button"
                  class="btn btn-success"
                  (click)="onSave()"
                  [disabled]="isLoading || getSelectedCount() === 0">
            <span *ngIf="isLoading" class="spinner-border spinner-border-sm mr-2"></span>
            {{ isLoading ? 'Enregistrement...' : 'Enregistrer (' + getSelectedCount() + ')' }}
            <i class="bx bx-save ml-1"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .table td {
    vertical-align: middle;
  }

  .table-responsive {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
  }

  .sticky-top {
    background-color: #f8f9fa !important;
    z-index: 10;
  }

  .text-truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .card {
    border-radius: 0.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .badge {
    font-size: 0.8em;
  }

  .form-control-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }

  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }

  .modal-xl {
    max-width: 1200px;
  }

  @media (max-width: 768px) {
    .modal-xl {
      max-width: 95%;
      margin: 1rem auto;
    }

    .table-responsive {
      font-size: 0.85em;
    }

    .text-truncate {
      max-width: 100px !important;
    }
  }
</style>
